#include <string.h>
#include <stdlib.h>
#include <unistd.h>
#include <stdio.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <sys/wait.h>
#include <fcntl.h>

//. / prog1 2>&1 > t m p f i l e | . / prog2 ; . / prog3 < t m p f i l e

// 0   in              dup(1,2)
// 1   out
// 2   err --> out

// 0   in 
// 1   out    -->tmpfile
// 2   out     -->tmpfile                2>&1 > t m p f i l e |

// 0   in 
// 1   out    -->tmpfile 
// 2   out   -->tmpfile --> tube

int main() {
    
    int tmpfile = open("./executables/Question2/tmpfile", O_RDONLY | O_WRONLY | O_CREAT);
    
    int tube_fd[2];
    pipe(tube_fd);

    if (!fork()){
        //dup2(1, 2); // 2-->out //pas necessaire
        close(tube_fd[0]); //fermer en lecture
        dup2(tmpfile, 1); //1 --> tmpfile
        dup2(tube_fd[1], 2);
        execl("./executables/Question2/prog1", "prog1", NULL);
        perror("Erreur survenue dans prog1 !\n");
    }

    if (!fork()) {
        close(tube_fd[1]); //ferme en ecriture
        dup2(tube_fd[0], STDIN_FILENO);
        execl("./executables/Question2/prog2", "prog2", NULL);
        perror("Erreur survenue dans prog2 !\n");
    }

    if(!fork()) {
        dup2(tmpfile, STDIN_FILENO);
        execl("./executables/Question2/prog3", "prog3", NULL);
        perror("Erreur survenue dans prog3 !\n");
    }

    return 0;
}  
    
    
    // int pip[2];
    // pipe(pip);
    // if (fork() == 0){   //ecriture tmpfile      . / prog1 2>&1 > t m p f i l e
    //     //int tmpFile = open("./executables/Question2/tmpfile", O_CREAT | O_RDWR);
    //     int tmpFile = open("./executables/Question2/tmpfile", O_RDWR | O_APPEND | O_CREAT, 0600);
    //     close(pip[0]);
    //     dup2(tmpFile, 1);
    //     dup2(pip[1], 2);
    //     close(tmpFile);
    //     close(pip[1]); 
    //     execl("./executables/Question2/prog1","prog1",NULL);
    //     perror("erreur 1");
    // }
    // //wait(NULL);
    // // if (fork() == 0){   //ecrire tmpfile vers tube      t m p f i l e |            //enleve
    // //     int tmpFile = open("./executables/Question2/tmpfile", O_RDWR);        
    // //     if (tmpFile < 0){
    // //         printf("erreur ouverture tmpFile\n");
    // //     }
    // //     close(pip[0]);      //fermer en lecture
    // //     char buff [300];
    // //     read(tmpFile,buff, 300);          //verifier 
    // //     write(pip[1],buff,strlen(buff));
        
    // //     close(tmpFile);
    // //     close(pip[1]); 
    // //     exit(0);
    // // }
    // if (fork() == 0){ //apres pipe          | . / prog2
    //     close(pip[1]);  //fermer en ecriture
    //     dup2(pip[0],0);
    //     close(pip[0]);
    //     execl("./executables/Question2/prog2","prog2",NULL);
    //     perror("erreur 2");
    // }
    // while(wait(NULL)>0);    
    // if (fork() == 0){   //         ./ prog3 < t m p f i l e
    //     int tmpFile = open("./executables/Question2/tmpfile", O_RDONLY);        

//         dup2(tmpFile,0);
//         close(tmpFile);
//         execl("./executables/Question2/prog3","prog3",NULL);
//         perror("erreur 3");
//     }
//     wait(NULL);
// }