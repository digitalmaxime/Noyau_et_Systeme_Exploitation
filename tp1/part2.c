/*
 * Clone Lab - part2.c
 * 
 * Ecole polytechnique de Montreal, 2018
 */

#include "libprocesslab.h"
#include <unistd.h>
#include <stdlib.h>
#include <sys/wait.h>
#include <stdio.h>

// TODO
// Si besoin, ajouter ici les directives d'inclusion
// -------------------------------------------------

// -------------------------------------------------

#define PART2_OUTPUT_FILE_PATH "part2Output.txt"

void part2() {
    // Ouverture du fichier de sortie pour la question 2.3
    FILE* part2OutputFile = fopen(PART2_OUTPUT_FILE_PATH, "a");
	char PID [256];
	sprintf(PID, "%d", getpid()); 
    // TODO
    
    
    //0
    fprintf(part2OutputFile, "Root process has pid %s",PID);
   
    	if(fork() == 0){	//1.1
		if (fork() == 0){ //2.1
			registerProc(2,1, getpid(), getppid());
			fprintf(part2OutputFile, " (message from process level2.1)\n");
			fclose(part2OutputFile);
			//execl("part2/level2.1", "level2.1", PID,NULL);
			char * env[] = {"TOKEN_DISABLE_FORK=826559d57d9b762c63fade93", NULL};
			execle("part2/level2.1", "level2.1", PID,NULL, env);
			exit(0);
		}
		if (fork() == 0){ //2.2
			registerProc(2,2, getpid(), getppid());
			execl("part2/level2.2", "level2.2", PID,NULL);
			exit(0);
		}
		while (wait(NULL) > 0);	
		registerProc(1,1, getpid(), getppid());
		fprintf(part2OutputFile, " (message from process level1.1)\n");
		fclose(part2OutputFile);
		execl("part2/level1.1", "level1.1", PID,NULL);
		exit(0);
	}
	
	
	if(fork() == 0){	//1.2
		if (fork() == 0){ //2.3
			registerProc(2,3, getpid(), getppid());
			fprintf(part2OutputFile, " (message from process level2.3)\n");
			fclose(part2OutputFile);
			execl("part2/level2.3", "level2.3", PID,NULL);
			exit(0);
		}
		while (wait(NULL) > 0);	
		registerProc(1,2, getpid(), getppid());
		execl("part2/level1.2", "level1.2", PID,NULL);
		exit(0);
	}
	
	if(fork() == 0){	//1.3
		if (fork() == 0){ //2.4
			registerProc(2,4, getpid(), getppid());
			fprintf(part2OutputFile, " (message from process level2.4)\n");
			fclose(part2OutputFile);
			execl("part2/level2.4", "level2.4", PID,NULL);
			exit(0);
		}
		while (wait(NULL) > 0);	
		registerProc(1,3, getpid(), getppid());
		execl("part2/level1.3", "level1.3", PID,NULL);
		exit(0);
	}
	
	if(fork() == 0){	//1.4
		if (fork() == 0){ //2.5
			registerProc(2,5, getpid(), getppid());
			execl("part2/level2.5", "level2.5", PID,NULL);
			exit(0);
		}
		while (wait(NULL) > 0);	
		registerProc(1,4, getpid(), getppid());

		fprintf(part2OutputFile, " (message from process level1.4)\n");
		fclose(part2OutputFile);
		exit(0);
	}
	while (wait(NULL) > 0);
	execl("part2/level0", "level0", "19479a736cb2952ecc3e7dc9", PID, NULL);
	fprintf(part2OutputFile, " (message from process level0)\n");
	fclose(part2OutputFile);
	
	
}
