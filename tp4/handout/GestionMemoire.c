#include "./libs/lib.h"
unsigned int calculerNumeroDePage(unsigned long adresse) {
	// TODO
	return adresse >> 10;
}

unsigned long calculerDeplacementDansLaPage(unsigned long adresse) {
	// TODO
	return adresse % 1024;
}

unsigned long calculerAdresseComplete(unsigned int numeroDePage, unsigned long deplacementDansLaPage) {
	// TODO
	numeroDePage = numeroDePage << 10;
	return numeroDePage + deplacementDansLaPage;
}

void rechercherTLB(struct RequeteMemoire* req, struct SystemeMemoire* mem) {
	// TODO
	unsigned long adresseVirtuelle = req->adresseVirtuelle;
	unsigned long numeroPage = calculerNumeroDePage(adresseVirtuelle);
	unsigned long deplacement = calculerDeplacementDansLaPage(adresseVirtuelle);
	for (int i=0; i< TAILLE_TLB; ++i) {
		if(mem->tlb->entreeValide[i] == 1 && mem->tlb->numeroPage[i] == numeroPage) {
			unsigned long numeroCadre = mem->tlb->numeroCadre[i];
			unsigned long adressePhysique = calculerAdresseComplete(numeroCadre, deplacement);
			req->adressePhysique = adressePhysique;
			mem->tlb->dernierAcces[i] = req->date;
			return;
		}
	}
	req->adressePhysique = 0;
}

void rechercherTableDesPages(struct RequeteMemoire* req, struct SystemeMemoire* mem) {
	// TODO
	unsigned long adresseVirtuelle = req->adresseVirtuelle;
	unsigned long numeroPage = calculerNumeroDePage(adresseVirtuelle);
	unsigned long deplacement = calculerDeplacementDansLaPage(adresseVirtuelle);
	if (mem->tp->entreeValide[numeroPage] == 1) {
		unsigned long numeroCadre = mem->tp->numeroCadre[numeroPage];
		unsigned long adressePhysique = calculerAdresseComplete(numeroCadre, deplacement);
		req->adressePhysique = adressePhysique;
		return;
	}
	req->adressePhysique = 0;

}

void ajouterDansMemoire(struct RequeteMemoire* req, struct SystemeMemoire* mem) {
	//TODO
	// Parcourir la mem jusqu'au premier index libre
	unsigned long adresseVirtuelle = req->adresseVirtuelle;
	unsigned long numeroPage = calculerNumeroDePage(adresseVirtuelle);
	unsigned long deplacement = calculerDeplacementDansLaPage(adresseVirtuelle);
	for (int i=0; i< TAILLE_MEMOIRE; ++i) {
		if(mem->memoire->utilisee[i] == 0) {
			//Memoire non-utilisee
			mem->memoire->numeroPage[i] = numeroPage;
			mem->memoire->utilisee[i] = 1;
			mem->memoire->dernierAcces[i] = req->date;
			mem->memoire->dateCreation[i] = req->date;
			// Mettre a jour adresse physique de la requete
			unsigned long numeroCadre = i;
			unsigned long adressePhysique = calculerAdresseComplete(numeroCadre, deplacement);
			req->adressePhysique = adressePhysique;
		}
	}	
}

void mettreAJourTLB(struct RequeteMemoire* req, struct SystemeMemoire* mem) {
	// TODO
	unsigned long adresseVirtuelle = req->adresseVirtuelle;
	unsigned long numeroPage = calculerNumeroDePage(adresseVirtuelle);
	unsigned long numeroCadre = mem->tp->numeroCadre[numeroPage];
	unsigned long deplacement = calculerDeplacementDansLaPage(adresseVirtuelle);
	unsigned long adressePhysique = calculerAdresseComplete(numeroCadre, deplacement);

	//Verifier si tlb non-plein + ajout info
	for(int i=0; i<TAILLE_TLB; i++) {
		if (mem->tlb->entreeValide[i] == 0) {
			mem->tlb->numeroCadre[i] = numeroCadre;
			mem->tlb->numeroPage[i] = numeroPage;
			mem->tlb->dateCreation[i] = req->date;
			mem->tlb->dernierAcces[i] = req->date;
			mem->tlb->entreeValide[i] = 1;
			//donner adresse physique a la requete
			req->adressePhysique = adressePhysique;
			return;
		}
	}

	//Si plein appliquer politique fifo
	unsigned long ancienneDate = mem->tlb->dateCreation[0];
	int idx = 0;
	for (int i=0; i<TAILLE_TLB; i++) {
		if (mem->tlb->dateCreation[i] < ancienneDate) {
			ancienneDate = mem->tlb->dateCreation[i];
			idx = i;
		}
	}
	//mettre a jour TLB
	mem->tlb->numeroCadre[idx] = numeroCadre;
	mem->tlb->numeroPage[idx] = numeroPage;
	mem->tlb->dateCreation[idx] = req->date;
	mem->tlb->dernierAcces[idx] = req->date;
	mem->tlb->entreeValide[idx] = 1;
	//donner adresse physique a la requete
	req->adressePhysique = adressePhysique;
}

// NE PAS MODIFIER
int main() {
    evaluate(
		&calculerNumeroDePage, 
		&calculerDeplacementDansLaPage, 
		&calculerAdresseComplete, 
        &rechercherTLB, 
		&rechercherTableDesPages,
		&mettreAJourTLB,
		&ajouterDansMemoire
    );
    return 0;
}
